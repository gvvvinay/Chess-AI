(function(){"use strict";function et(o){return o!==null?{comment:o,variations:[]}:{variations:[]}}function tt(o,t,e,s,i){const n={move:o,variations:i};return t&&(n.suffix=t),e&&(n.nag=e),s!==null&&(n.comment=s),n}function st(...o){const[t,...e]=o;let s=t;for(const i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function it(o,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:o,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function rt(o,t){function e(){this.constructor=o}e.prototype=t.prototype,o.prototype=new e}function H(o,t,e,s){var i=Error.call(this,o);return Object.setPrototypeOf&&Object.setPrototypeOf(i,H.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}rt(H,Error);function le(o,t,e){return e=e||" ",o.length>t?o:(t-=o.length,e+=e.repeat(t),o+e.slice(0,t))}H.prototype.format=function(o){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<o.length;s++)if(o[s].source===this.location.source){e=o[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,n=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,a=this.location.source+":"+n.line+":"+n.column;if(e){var c=this.location.end,u=le("",n.line.toString().length," "),p=e[i.line-1],d=i.line===c.line?c.column:p.length+1,A=d-i.column||1;t+=`
 --> `+a+`
`+u+` |
`+n.line+" | "+p+`
`+u+" | "+le("",i.column-1," ")+le("",A,"^")}else t+=`
 at `+a}return t},H.buildMessage=function(o,t){var e={literal:function(p){return'"'+i(p.text)+'"'},class:function(p){var d=p.parts.map(function(A){return Array.isArray(A)?n(A[0])+"-"+n(A[1]):n(A)});return"["+(p.inverted?"^":"")+d.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function s(p){return p.charCodeAt(0).toString(16).toUpperCase()}function i(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(d){return"\\x0"+s(d)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(d){return"\\x"+s(d)})}function n(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(d){return"\\x0"+s(d)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(d){return"\\x"+s(d)})}function a(p){return e[p.type](p)}function c(p){var d=p.map(a),A,g;if(d.sort(),d.length>0){for(A=1,g=1;A<d.length;A++)d[A-1]!==d[A]&&(d[g]=d[A],g++);d.length=g}switch(d.length){case 1:return d[0];case 2:return d[0]+" or "+d[1];default:return d.slice(0,-1).join(", ")+", or "+d[d.length-1]}}function u(p){return p?'"'+i(p)+'"':"end of input"}return"Expected "+c(o)+" but "+u(t)+" found."};function nt(o,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:We},n=We,a="[",c='"',u="]",p=".",d="O-O-O",A="O-O",g="0-0-0",E="0-0",k="$",y="{",R="}",ve=";",be="(",Tt=")",Pe="1-0",we="0-1",Ne="1/2-1/2",Pt="*",Ee=/^[a-zA-Z]/,Ie=/^[^"]/,re=/^[0-9]/,xe=/^[.]/,Oe=/^[a-zA-Z1-8\-=]/,wt=/^[+#]/,Me=/^[!?]/,Le=/^[^}]/,Ke=/^[^\r\n]/,qe=/^[ \t\r\n]/,Nt=L("tag pair"),It=N("[",!1),Re=N('"',!1),xt=N("]",!1),Ot=L("tag name"),Se=q([["a","z"],["A","Z"]],!1,!1),Mt=L("tag value"),Fe=q(['"'],!0,!1),Lt=L("move number"),ne=q([["0","9"]],!1,!1),Kt=N(".",!1),De=q(["."],!1,!1),qt=L("standard algebraic notation"),Rt=N("O-O-O",!1),Ft=N("O-O",!1),Dt=N("0-0-0",!1),Ut=N("0-0",!1),Ue=q([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Bt=q(["+","#"],!1,!1),Qt=L("suffix annotation"),Be=q(["!","?"],!1,!1),jt=L("NAG"),Ht=N("$",!1),Gt=L("brace comment"),Vt=N("{",!1),Qe=q(["}"],!0,!1),Wt=N("}",!1),Yt=L("rest of line comment"),zt=N(";",!1),je=q(["\r",`
`],!0,!1),Zt=L("variation"),Jt=N("(",!1),Xt=N(")",!1),es=L("game termination marker"),ts=N("1-0",!1),ss=N("0-1",!1),is=N("1/2-1/2",!1),rs=N("*",!1),ns=L("whitespace"),He=q([" ","	","\r",`
`],!1,!1),os=function(r,f){return it(r,f)},as=function(r){return Object.fromEntries(r)},ls=function(r,f){return[r,f]},fs=function(r,f){return{root:r,marker:f}},hs=function(r,f){return st(et(r),...f.flat())},cs=function(r,f,h,v,b){return tt(r,f,h,v,b)},us=function(r){return r},ps=function(r){return r.replace(/[\r\n]+/g," ")},_s=function(r){return r.trim()},gs=function(r){return r},ds=function(r,f){return{result:r,comment:f}},l=t.peg$currPos|0,G=[{line:1,column:1}],K=l,oe=t.peg$maxFailExpected||[],_=t.peg$silentFails|0,z;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');n=i[t.startRule]}function N(r,f){return{type:"literal",text:r,ignoreCase:f}}function q(r,f,h){return{type:"class",parts:r,inverted:f,ignoreCase:h}}function ms(){return{type:"end"}}function L(r){return{type:"other",description:r}}function Ge(r){var f=G[r],h;if(f)return f;if(r>=G.length)h=G.length-1;else for(h=r;!G[--h];);for(f=G[h],f={line:f.line,column:f.column};h<r;)o.charCodeAt(h)===10?(f.line++,f.column=1):f.column++,h++;return G[r]=f,f}function Ve(r,f,h){var v=Ge(r),b=Ge(f),$={source:s,start:{offset:r,line:v.line,column:v.column},end:{offset:f,line:b.line,column:b.column}};return $}function m(r){l<K||(l>K&&(K=l,oe=[]),oe.push(r))}function vs(r,f,h){return new H(H.buildMessage(r,f),r,f,h)}function We(){var r,f,h;return r=l,f=bs(),h=Cs(),r=os(f,h),r}function bs(){var r,f,h;for(r=l,f=[],h=Ye();h!==e;)f.push(h),h=Ye();return h=O(),r=as(f),r}function Ye(){var r,f,h,v,b,$,j;return _++,r=l,O(),o.charCodeAt(l)===91?(f=a,l++):(f=e,_===0&&m(It)),f!==e?(O(),h=Es(),h!==e?(O(),o.charCodeAt(l)===34?(v=c,l++):(v=e,_===0&&m(Re)),v!==e?(b=Ss(),o.charCodeAt(l)===34?($=c,l++):($=e,_===0&&m(Re)),$!==e?(O(),o.charCodeAt(l)===93?(j=u,l++):(j=e,_===0&&m(xt)),j!==e?r=ls(h,b):(l=r,r=e)):(l=r,r=e)):(l=r,r=e)):(l=r,r=e)):(l=r,r=e),_--,r===e&&_===0&&m(Nt),r}function Es(){var r,f,h;if(_++,r=l,f=[],h=o.charAt(l),Ee.test(h)?l++:(h=e,_===0&&m(Se)),h!==e)for(;h!==e;)f.push(h),h=o.charAt(l),Ee.test(h)?l++:(h=e,_===0&&m(Se));else f=e;return f!==e?r=o.substring(r,l):r=f,_--,r===e&&(f=e,_===0&&m(Ot)),r}function Ss(){var r,f,h;for(_++,r=l,f=[],h=o.charAt(l),Ie.test(h)?l++:(h=e,_===0&&m(Fe));h!==e;)f.push(h),h=o.charAt(l),Ie.test(h)?l++:(h=e,_===0&&m(Fe));return r=o.substring(r,l),_--,f=e,_===0&&m(Mt),r}function Cs(){var r,f,h;return r=l,f=ze(),O(),h=Ps(),h===e&&(h=null),O(),r=fs(f,h),r}function ze(){var r,f,h,v;for(r=l,f=Ce(),f===e&&(f=null),h=[],v=Ze();v!==e;)h.push(v),v=Ze();return r=hs(f,h),r}function Ze(){var r,f,h,v,b,$,j,ae;if(r=l,O(),As(),O(),f=ks(),f!==e){for(h=$s(),h===e&&(h=null),v=[],b=Je();b!==e;)v.push(b),b=Je();for(b=O(),$=Ce(),$===e&&($=null),j=[],ae=Xe();ae!==e;)j.push(ae),ae=Xe();r=cs(f,h,v,$,j)}else l=r,r=e;return r}function As(){var r,f,h,v,b,$;for(_++,r=l,f=[],h=o.charAt(l),re.test(h)?l++:(h=e,_===0&&m(ne));h!==e;)f.push(h),h=o.charAt(l),re.test(h)?l++:(h=e,_===0&&m(ne));if(o.charCodeAt(l)===46?(h=p,l++):(h=e,_===0&&m(Kt)),h!==e){for(v=O(),b=[],$=o.charAt(l),xe.test($)?l++:($=e,_===0&&m(De));$!==e;)b.push($),$=o.charAt(l),xe.test($)?l++:($=e,_===0&&m(De));f=[f,h,v,b],r=f}else l=r,r=e;return _--,r===e&&(f=e,_===0&&m(Lt)),r}function ks(){var r,f,h,v,b,$;if(_++,r=l,f=l,o.substr(l,5)===d?(h=d,l+=5):(h=e,_===0&&m(Rt)),h===e&&(o.substr(l,3)===A?(h=A,l+=3):(h=e,_===0&&m(Ft)),h===e&&(o.substr(l,5)===g?(h=g,l+=5):(h=e,_===0&&m(Dt)),h===e&&(o.substr(l,3)===E?(h=E,l+=3):(h=e,_===0&&m(Ut)),h===e))))if(h=l,v=o.charAt(l),Ee.test(v)?l++:(v=e,_===0&&m(Se)),v!==e){if(b=[],$=o.charAt(l),Oe.test($)?l++:($=e,_===0&&m(Ue)),$!==e)for(;$!==e;)b.push($),$=o.charAt(l),Oe.test($)?l++:($=e,_===0&&m(Ue));else b=e;b!==e?(v=[v,b],h=v):(l=h,h=e)}else l=h,h=e;return h!==e?(v=o.charAt(l),wt.test(v)?l++:(v=e,_===0&&m(Bt)),v===e&&(v=null),h=[h,v],f=h):(l=f,f=e),f!==e?r=o.substring(r,l):r=f,_--,r===e&&(f=e,_===0&&m(qt)),r}function $s(){var r,f,h;for(_++,r=l,f=[],h=o.charAt(l),Me.test(h)?l++:(h=e,_===0&&m(Be));h!==e;)f.push(h),f.length>=2?h=e:(h=o.charAt(l),Me.test(h)?l++:(h=e,_===0&&m(Be)));return f.length<1?(l=r,r=e):r=f,_--,r===e&&(f=e,_===0&&m(Qt)),r}function Je(){var r,f,h,v,b;if(_++,r=l,O(),o.charCodeAt(l)===36?(f=k,l++):(f=e,_===0&&m(Ht)),f!==e){if(h=l,v=[],b=o.charAt(l),re.test(b)?l++:(b=e,_===0&&m(ne)),b!==e)for(;b!==e;)v.push(b),b=o.charAt(l),re.test(b)?l++:(b=e,_===0&&m(ne));else v=e;v!==e?h=o.substring(h,l):h=v,h!==e?r=us(h):(l=r,r=e)}else l=r,r=e;return _--,r===e&&_===0&&m(jt),r}function Ce(){var r;return r=ys(),r===e&&(r=Ts()),r}function ys(){var r,f,h,v,b;if(_++,r=l,o.charCodeAt(l)===123?(f=y,l++):(f=e,_===0&&m(Vt)),f!==e){for(h=l,v=[],b=o.charAt(l),Le.test(b)?l++:(b=e,_===0&&m(Qe));b!==e;)v.push(b),b=o.charAt(l),Le.test(b)?l++:(b=e,_===0&&m(Qe));h=o.substring(h,l),o.charCodeAt(l)===125?(v=R,l++):(v=e,_===0&&m(Wt)),v!==e?r=ps(h):(l=r,r=e)}else l=r,r=e;return _--,r===e&&(f=e,_===0&&m(Gt)),r}function Ts(){var r,f,h,v,b;if(_++,r=l,o.charCodeAt(l)===59?(f=ve,l++):(f=e,_===0&&m(zt)),f!==e){for(h=l,v=[],b=o.charAt(l),Ke.test(b)?l++:(b=e,_===0&&m(je));b!==e;)v.push(b),b=o.charAt(l),Ke.test(b)?l++:(b=e,_===0&&m(je));h=o.substring(h,l),r=_s(h)}else l=r,r=e;return _--,r===e&&(f=e,_===0&&m(Yt)),r}function Xe(){var r,f,h,v;return _++,r=l,O(),o.charCodeAt(l)===40?(f=be,l++):(f=e,_===0&&m(Jt)),f!==e?(h=ze(),h!==e?(O(),o.charCodeAt(l)===41?(v=Tt,l++):(v=e,_===0&&m(Xt)),v!==e?r=gs(h):(l=r,r=e)):(l=r,r=e)):(l=r,r=e),_--,r===e&&_===0&&m(Zt),r}function Ps(){var r,f,h;return _++,r=l,o.substr(l,3)===Pe?(f=Pe,l+=3):(f=e,_===0&&m(ts)),f===e&&(o.substr(l,3)===we?(f=we,l+=3):(f=e,_===0&&m(ss)),f===e&&(o.substr(l,7)===Ne?(f=Ne,l+=7):(f=e,_===0&&m(is)),f===e&&(o.charCodeAt(l)===42?(f=Pt,l++):(f=e,_===0&&m(rs))))),f!==e?(O(),h=Ce(),h===e&&(h=null),r=ds(f,h)):(l=r,r=e),_--,r===e&&(f=e,_===0&&m(es)),r}function O(){var r,f;for(_++,r=[],f=o.charAt(l),qe.test(f)?l++:(f=e,_===0&&m(He));f!==e;)r.push(f),f=o.charAt(l),qe.test(f)?l++:(f=e,_===0&&m(He));return _--,f=e,_===0&&m(ns),r}if(z=n(),t.peg$library)return{peg$result:z,peg$currPos:l,peg$FAILED:e,peg$maxFailExpected:oe,peg$maxFailPos:K};if(z!==e&&l===o.length)return z;throw z!==e&&l<o.length&&m(ms()),vs(oe,K<o.length?o.charAt(K):null,K<o.length?Ve(K,K+1):Ve(K,K))}const Z=0xffffffffffffffffn;function fe(o,t){return(o<<t|o>>64n-t)&0xffffffffffffffffn}function Ae(o,t){return o*t&Z}function ot(o){return function(){let t=BigInt(o&Z),e=BigInt(o>>64n&Z);const s=Ae(fe(Ae(t,5n),7n),9n);return e^=t,t=(fe(t,24n)^e^e<<16n)&Z,e=fe(e,37n),o=e<<64n|t,s}}const J=ot(0xa187eb39cdcaed8f31c4b365b102e01en),at=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>J()))),lt=Array.from({length:8},()=>J()),ft=Array.from({length:16},()=>J()),he=J(),x="w",M="b",T="p",ce="n",X="b",V="r",F="q",P="k",ue="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class ee{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){const{color:s,piece:i,from:n,to:a,flags:c,captured:u,promotion:p}=e,d=w(n),A=w(a);this.color=s,this.piece=i,this.from=d,this.to=A,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=d+A,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const g in C)C[g]&c&&(this.flags+=B[g]);u&&(this.captured=u),p&&(this.promotion=p,this.lan+=p)}isCapture(){return this.flags.indexOf(B.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(B.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(B.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(B.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(B.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(B.BIG_PAWN)>-1}}const I=-1,B={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},C={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},pe={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},ht={...pe,...{WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null}},S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},_e={b:[16,32,17,15],w:[-16,-32,-17,-15]},ke={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ct=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],ut=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],pt={p:1,n:2,b:4,r:8,q:16,k:32},_t="pnbrqkPNBRQK",$e=[ce,X,V,F],gt=7,dt=6,mt=1,vt=0,te={[P]:C.KSIDE_CASTLE,[F]:C.QSIDE_CASTLE},D={w:[{square:S.a1,flag:C.QSIDE_CASTLE},{square:S.h1,flag:C.KSIDE_CASTLE}],b:[{square:S.a8,flag:C.QSIDE_CASTLE},{square:S.h8,flag:C.KSIDE_CASTLE}]},bt={b:mt,w:dt},ge="--";function Q(o){return o>>4}function W(o){return o&15}function ye(o){return"0123456789".indexOf(o)!==-1}function w(o){const t=W(o),e=Q(o);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function Y(o){return o===x?M:x}function Et(o){const t=o.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let a=0;a<i.length;a++){let c=0,u=!1;for(let p=0;p<i[a].length;p++)if(ye(i[a][p])){if(u)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};c+=parseInt(i[a][p],10),u=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[a][p]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};c+=1,u=!1}if(c!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const n=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:a,regex:c}of n){if(!c.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${a} king`};if((t[0].match(c)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${a} kings`}}return Array.from(i[0]+i[7]).some(a=>a.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function St(o,t){const e=o.from,s=o.to,i=o.piece;let n=0,a=0,c=0;for(let u=0,p=t.length;u<p;u++){const d=t[u].from,A=t[u].to,g=t[u].piece;i===g&&e!==d&&s===A&&(n++,Q(e)===Q(d)&&a++,W(e)===W(d)&&c++)}return n>0?a>0&&c>0?w(e):c>0?w(e).charAt(1):w(e).charAt(0):""}function U(o,t,e,s,i,n=void 0,a=C.NORMAL){const c=Q(s);if(i===T&&(c===gt||c===vt))for(let u=0;u<$e.length;u++){const p=$e[u];o.push({color:t,from:e,to:s,piece:i,captured:n,promotion:p,flags:a|C.PROMOTION})}else o.push({color:t,from:e,to:s,piece:i,captured:n,flags:a})}function Te(o){let t=o.charAt(0);return t>="a"&&t<="h"?o.match(/[a-h]\d.*[a-h]\d/)?void 0:T:(t=t.toLowerCase(),t==="o"?P:t)}function de(o){return o.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Ct{_board=new Array(128);_turn=x;_header={};_kings={w:I,b:I};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=ue,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:I,b:I},this._turn=x,this._castling={w:0,b:0},this._epSquare=I,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...ht},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const c=["-","-","0","1"];t=i.concat(c.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){const{ok:c,error:u}=Et(t);if(!c)throw new Error(u)}const n=i[0];let a=0;this.clear({preserveHeaders:s});for(let c=0;c<n.length;c++){const u=n.charAt(c);if(u==="/")a+=8;else if(ye(u))a+=parseInt(u,10);else{const p=u<"a"?x:M;this._put({type:u.toLowerCase(),color:p},w(a)),a++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=C.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=C.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=C.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=C.QSIDE_CASTLE),this._epSquare=i[3]==="-"?I:S[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let a=S.a8;a<=S.h1;a++){if(this._board[a]){e>0&&(s+=e,e=0);const{color:c,type:u}=this._board[a];s+=c===x?u.toUpperCase():u.toLowerCase()}else e++;a+1&136&&(e>0&&(s+=e),a!==S.h1&&(s+="/"),e=0,a+=8)}let i="";this._castling[x]&C.KSIDE_CASTLE&&(i+="K"),this._castling[x]&C.QSIDE_CASTLE&&(i+="Q"),this._castling[M]&C.KSIDE_CASTLE&&(i+="k"),this._castling[M]&C.QSIDE_CASTLE&&(i+="q"),i=i||"-";let n="-";if(this._epSquare!==I)if(t)n=w(this._epSquare);else{const a=this._epSquare+(this._turn===x?16:-16),c=[a+1,a-1];for(const u of c){if(u&136)continue;const p=this._turn;if(this._board[u]?.color===p&&this._board[u]?.type===T){this._makeMove({color:p,from:u,to:this._epSquare,piece:T,captured:T,flags:C.EP_CAPTURE});const d=!this._isKingAttacked(p);if(this._undoMove(),d){n=w(this._epSquare);break}}}}return[s,this._turn,i,n,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],i={w:0,b:1}[e],n={p:0,n:1,b:2,r:3,q:4,k:5}[s];return at[i][n][t]}_epKey(){return this._epSquare===I?0n:lt[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return ft[t]}_computeHash(){let t=0n;for(let e=S.a8;e<=S.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=he),t}_updateSetup(t){this._history.length>0||(t!==ue?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(ue)}get(t){return this._board[S[t]]}findPiece(t){const e=[];for(let s=S.a8;s<=S.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(w(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(_t.indexOf(t.toLowerCase())===-1||!(s in S))return!1;const i=S[s];if(t==P&&!(this._kings[e]==I||this._kings[e]==i))return!1;const n=this._board[i];return n&&n.type===P&&(this._kings[n.color]=I),this._set(i,{type:t,color:e}),t===P&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(S[t]),e&&e.type===P&&(this._kings[e.color]=I),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();const t=this._board[S.e1]?.type===P&&this._board[S.e1]?.color===x,e=this._board[S.e8]?.type===P&&this._board[S.e8]?.color===M;(!t||this._board[S.a1]?.type!==V||this._board[S.a1]?.color!==x)&&(this._castling.w&=-65),(!t||this._board[S.h1]?.type!==V||this._board[S.h1]?.color!==x)&&(this._castling.w&=-33),(!e||this._board[S.a8]?.type!==V||this._board[S.a8]?.color!==M)&&(this._castling.b&=-65),(!e||this._board[S.h8]?.type!==V||this._board[S.h8]?.color!==M)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===I)return;const t=this._epSquare+(this._turn===x?-16:16),e=this._epSquare+(this._turn===x?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==Y(this._turn)||this._board[e]?.type!==T){this._hash^=this._epKey(),this._epSquare=I;return}const i=n=>!(n&136)&&this._board[n]?.color===this._turn&&this._board[n]?.type===T;s.some(i)||(this._hash^=this._epKey(),this._epSquare=I)}_attacked(t,e,s){const i=[];for(let n=S.a8;n<=S.h1;n++){if(n&136){n+=7;continue}if(this._board[n]===void 0||this._board[n].color!==t)continue;const a=this._board[n],c=n-e;if(c===0)continue;const u=c+119;if(ct[u]&pt[a.type]){if(a.type===T){if(c>0&&a.color===x||c<=0&&a.color===M)if(s)i.push(w(n));else return!0;continue}if(a.type==="n"||a.type==="k")if(s){i.push(w(n));continue}else return!0;const p=ut[u];let d=n+p,A=!1;for(;d!==e;){if(this._board[d]!=null){A=!0;break}d+=p}if(!A)if(s){i.push(w(n));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,S[t],!0):this._attacked(this._turn,S[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(Y(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,S[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,i=0;for(let n=S.a8;n<=S.h1;n++){if(i=(i+1)%2,n&136){n+=7;continue}const a=this._board[n];a&&(t[a.type]=a.type in t?t[a.type]+1:1,a.type===X&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[X]===1||t[ce]===1))return!0;if(s===t[X]+2){let n=0;const a=e.length;for(let c=0;c<a;c++)n+=e[c];if(n===0||n===a)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const i=this._moves({square:e,piece:s});return t?i.map(n=>new ee(this,n)):i.map(n=>this._moveToSan(n,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){const i=s?s.toLowerCase():void 0,n=e?.toLowerCase(),a=[],c=this._turn,u=Y(c);let p=S.a8,d=S.h1,A=!1;if(i)if(i in S)p=d=S[i],A=!0;else return[];for(let E=p;E<=d;E++){if(E&136){E+=7;continue}if(!this._board[E]||this._board[E].color===u)continue;const{type:k}=this._board[E];let y;if(k===T){if(n&&n!==k)continue;y=E+_e[c][0],this._board[y]||(U(a,c,E,y,T),y=E+_e[c][1],bt[c]===Q(E)&&!this._board[y]&&U(a,c,E,y,T,void 0,C.BIG_PAWN));for(let R=2;R<4;R++)y=E+_e[c][R],!(y&136)&&(this._board[y]?.color===u?U(a,c,E,y,T,this._board[y].type,C.CAPTURE):y===this._epSquare&&U(a,c,E,y,T,T,C.EP_CAPTURE))}else{if(n&&n!==k)continue;for(let R=0,ve=ke[k].length;R<ve;R++){const be=ke[k][R];for(y=E;y+=be,!(y&136);){if(!this._board[y])U(a,c,E,y,k);else{if(this._board[y].color===c)break;U(a,c,E,y,k,this._board[y].type,C.CAPTURE);break}if(k===ce||k===P)break}}}}if((n===void 0||n===P)&&(!A||d===this._kings[c])){if(this._castling[c]&C.KSIDE_CASTLE){const E=this._kings[c],k=E+2;!this._board[E+1]&&!this._board[k]&&!this._attacked(u,this._kings[c])&&!this._attacked(u,E+1)&&!this._attacked(u,k)&&U(a,c,this._kings[c],k,P,void 0,C.KSIDE_CASTLE)}if(this._castling[c]&C.QSIDE_CASTLE){const E=this._kings[c],k=E-2;!this._board[E-1]&&!this._board[E-2]&&!this._board[E-3]&&!this._attacked(u,this._kings[c])&&!this._attacked(u,E-1)&&!this._attacked(u,k)&&U(a,c,this._kings[c],k,P,void 0,C.QSIDE_CASTLE)}}if(!t||this._kings[c]===-1)return a;const g=[];for(let E=0,k=a.length;E<k;E++)this._makeMove(a[E]),this._isKingAttacked(c)||g.push(a[E]),this._undoMove();return g}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(ge,e);else if(typeof t=="object"){const n=this._moves();for(let a=0,c=n.length;a<c;a++)if(t.from===w(n[a].from)&&t.to===w(n[a].to)&&(!("promotion"in n[a])||t.promotion===n[a].promotion)){s=n[a];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&C.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new ee(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){const e=this._turn,s=Y(e);if(this._push(t),t.flags&C.NULL_MOVE){e===M&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=I;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&C.EP_CAPTURE&&(this._turn===M?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===P){if(this._kings[e]=t.to,t.flags&C.KSIDE_CASTLE){const i=t.to-1,n=t.to+1;this._movePiece(n,i)}else if(t.flags&C.QSIDE_CASTLE){const i=t.to+1,n=t.to-2;this._movePiece(n,i)}this._castling[e]=0}if(this._castling[e]){for(let i=0,n=D[e].length;i<n;i++)if(t.from===D[e][i].square&&this._castling[e]&D[e][i].flag){this._castling[e]^=D[e][i].flag;break}}if(this._castling[s]){for(let i=0,n=D[s].length;i<n;i++)if(t.to===D[s][i].square&&this._castling[s]&D[s][i].flag){this._castling[s]^=D[s][i].flag;break}}if(this._hash^=this._castlingKey(),t.flags&C.BIG_PAWN){let i;e===M?i=t.to-16:i=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===T&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===T&&this._board[t.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=I}else this._epSquare=I;t.piece===T?this._halfMoves=0:t.flags&(C.CAPTURE|C.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===M&&this._moveNumber++,this._turn=s,this._hash^=he}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new ee(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=he;const s=this._turn,i=Y(s);if(e.flags&C.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&C.EP_CAPTURE){let n;s===M?n=e.to-16:n=e.to+16,this._set(n,{type:T,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(C.KSIDE_CASTLE|C.QSIDE_CASTLE)){let n,a;e.flags&C.KSIDE_CASTLE?(n=e.to+1,a=e.to-1):(n=e.to-2,a=e.to+1),this._movePiece(a,n)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let i=!1;for(const g in this._header)this._header[g]&&s.push(`[${g} "${this._header[g]}"]`+t),i=!0;i&&this._history.length&&s.push(t);const n=g=>{const E=this._comments[this.fen()];if(typeof E<"u"){const k=g.length>0?" ":"";g=`${g}${k}{${E}}`}return g},a=[];for(;this._history.length>0;)a.push(this._undoMove());const c=[];let u="";for(a.length===0&&c.push(n(""));a.length>0;){u=n(u);const g=a.pop();if(!g)break;if(!this._history.length&&g.color==="b"){const E=`${this._moveNumber}. ...`;u=u?`${u} ${E}`:E}else g.color==="w"&&(u.length&&c.push(u),u=this._moveNumber+".");u=u+" "+this._moveToSan(g,this._moves({legal:!0})),this._makeMove(g)}if(u.length&&c.push(n(u)),c.push(this._header.Result||"*"),e===0)return s.join("")+c.join(" ");const p=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},d=function(g,E){for(const k of E.split(" "))if(k){if(g+k.length>e){for(;p();)g--;s.push(t),g=0}s.push(k),g+=k.length,s.push(" "),g++}return p()&&g--,g};let A=0;for(let g=0;g<c.length;g++){if(A+c[g].length>e&&c[g].includes("{")){A=d(A,c[g]);continue}A+c[g].length>e&&g!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),A=0):g!==0&&(s.push(" "),A++),s.push(c[g]),A+=c[g].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??pe[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=pe[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const i=nt(t);this.reset();const n=i.headers;let a="";for(const p in n)p.toLowerCase()==="fen"&&(a=n[p]),this.header(p,n[p]);if(!e)a&&this.load(a,{preserveHeaders:!0});else if(n.SetUp==="1"){if(!("FEN"in n))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(n.FEN,{preserveHeaders:!0})}let c=i.root;for(;c;){if(c.move){const p=this._moveFromSan(c.move,e);if(p==null)throw new Error(`Invalid move in PGN: ${c.move}`);this._makeMove(p),this._incPositionCount()}c.comment!==void 0&&(this._comments[this.fen()]=c.comment),c=c.variations[0]}const u=i.result;u&&Object.keys(this._header).length&&this._header.Result!==u&&this.setHeader("Result",u)}_moveToSan(t,e){let s="";if(t.flags&C.KSIDE_CASTLE)s="O-O";else if(t.flags&C.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&C.NULL_MOVE)return ge;if(t.piece!==T){const i=St(t,e);s+=t.piece.toUpperCase()+i}t.flags&(C.CAPTURE|C.EP_CAPTURE)&&(t.piece===T&&(s+=w(t.from)[0]),s+="x"),s+=w(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=de(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==ge)return{color:this._turn,from:0,to:0,piece:"k",flags:C.NULL_MOVE};let i=Te(s),n=this._moves({legal:!0,piece:i});for(let g=0,E=n.length;g<E;g++)if(s===de(this._moveToSan(n[g],n)))return n[g];if(e)return null;let a,c,u,p,d,A=!1;if(c=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),c?(a=c[1],u=c[2],p=c[3],d=c[4],u.length==1&&(A=!0)):(c=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),c&&(a=c[1],u=c[2],p=c[3],d=c[4],u.length==1&&(A=!0))),i=Te(s),n=this._moves({legal:!0,piece:a||i}),!p)return null;for(let g=0,E=n.length;g<E;g++)if(u){if((!a||a.toLowerCase()==n[g].piece)&&S[u]==n[g].from&&S[p]==n[g].to&&(!d||d.toLowerCase()==n[g].promotion))return n[g];if(A){const k=w(n[g].from);if((!a||a.toLowerCase()==n[g].piece)&&S[p]==n[g].to&&(u==k[0]||u==k[1])&&(!d||d.toLowerCase()==n[g].promotion))return n[g]}}else if(s===de(this._moveToSan(n[g],n)).replace("x",""))return n[g];return null}ascii(){let t=`   +------------------------+
`;for(let e=S.a8;e<=S.h1;e++){if(W(e)===0&&(t+=" "+"87654321"[Q(e)]+" |"),this._board[e]){const s=this._board[e].type,n=this._board[e].color===x?s.toUpperCase():s.toLowerCase();t+=" "+n+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const i=this._turn;for(let n=0,a=e.length;n<a;n++)this._makeMove(e[n]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=S.a8;s<=S.h1;s++)this._board[s]==null?e.push(null):e.push({square:w(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in S){const e=S[t];return(Q(e)+W(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const i=e.pop();if(!i)break;t?s.push(new ee(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const i of[P,F])e[i]!==void 0&&(e[i]?this._castling[t]|=te[i]:this._castling[t]&=~te[i]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[P]===void 0||e[P]===s[P])&&(e[F]===void 0||e[F]===s[F])}getCastlingRights(t){return{[P]:(this._castling[t]&te[P])!==0,[F]:(this._castling[t]&te[F])!==0}}moveNumber(){return this._moveNumber}}const At={p:100,n:320,b:330,r:500,q:900,k:2e4},kt={p:[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]],n:[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],b:[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,10,10,5,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],r:[[0,0,0,0,0,0,0,0],[5,10,10,10,10,10,10,5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[0,0,0,5,5,0,0,0]],q:[[-20,-10,-10,-5,-5,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,5,5,5,0,-10],[-5,0,5,5,5,5,0,-5],[0,0,5,5,5,5,0,-5],[-10,5,5,5,5,5,0,-10],[-10,0,5,0,0,0,0,-10],[-20,-10,-10,-5,-5,-10,-10,-20]],k:[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]]};function $t(o){let t=0;const e=o.board();for(let s=0;s<8;s++)for(let i=0;i<8;i++){const n=e[s][i];if(n){let a=At[n.type];const c=kt[n.type];c&&(n.color==="w"?a+=c[s][i]:a+=c[7-s][i]),t+=n.color==="w"?a:-a}}return t}function me(o,t,e,s,i){if(t===0||o.isGameOver())return o.isCheckmate()?o.turn()==="w"?-99999:99999:o.isDraw()?0:$t(o);if((se||Date.now()>ie)&&t>0)return se=!0,0;const n=o.moves();if(n.sort((a,c)=>{const u=a.includes("x"),p=c.includes("x");return u&&!p?-1:!u&&p?1:0}),i){let a=-1/0;for(const c of n){o.move(c);const u=me(o,t-1,e,s,!1);if(o.undo(),a=Math.max(a,u),e=Math.max(e,u),s<=e)break}return a}else{let a=1/0;for(const c of n){o.move(c);const u=me(o,t-1,e,s,!0);if(o.undo(),a=Math.min(a,u),s=Math.min(s,u),s<=e)break}return a}}let se=!1,ie=0;function yt(o,t=1e3){const e=o.moves({verbose:!0});if(e.length===0)return null;e.sort((a,c)=>{const u=a.flags.includes("c")||a.flags.includes("e"),p=c.flags.includes("c")||c.flags.includes("e");return u&&!p?-1:!u&&p?1:0});let s=e[0].san,i=[];se=!1,ie=Date.now()+t;const n=6;for(let a=1;a<=n;a++){let c=[],u=!0;for(const p of e){if(Date.now()>ie){se=!0,u=!1;break}const d=p.san;o.move(d);const A=me(o,a-1,-1/0,1/0,o.turn()==="w");o.undo(),c.push({move:d,score:A})}if(u&&c.length>0){const p=o.turn()==="w";c.sort((d,A)=>p?A.score-d.score:d.score-A.score),s=c[0].move,i=c}else break;if(Date.now()>ie-20)break}if(i.length>1){const a=i[0].score,c=30,u=o.turn()==="w",p=i.filter(d=>(u?a-d.score:d.score-a)<=c);if(p.length>0)return p[Math.floor(Math.random()*p.length)].move}return s}self.onmessage=o=>{const{pgn:t,fen:e,depth:s,turnColor:i}=o.data,n=new Ct;try{t?n.loadPgn(t):e&&n.load(e)}catch{e&&n.load(e)}n.turn(),i[0];try{let a=500;s===1&&(a=200),s===2&&(a=500),s===3&&(a=1e3),s===4&&(a=2e3);const c=yt(n,a);self.postMessage({move:c})}catch(a){console.error("Worker Error:",a),self.postMessage({error:a})}}})();
